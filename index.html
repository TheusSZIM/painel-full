<script>
    // ===================================================================== //
    // ==         C√ìDIGO FINAL CORRIGIDO PARA API DO GOOGLE APPS SCRIPT     == //
    // ===================================================================== //
    document.addEventListener('DOMContentLoaded', () => {
        // URL da sua nova API do Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbyNjlij0FIiSeQO133kCRO3JYle1BWL8OrZPJWET9t9zx5aKADH1IAtojBu8iQrfK2lgA/exec';
        
        // Sele√ß√£o de todos os elementos do DOM
        const loadingOverlay = document.getElementById('loadingOverlay');
        const requestsList = document.getElementById('requestsList');
        const emptyState = document.getElementById('emptyState');
        const pendingCountEl = document.getElementById('pendingCount');
        const inProgressCountEl = document.getElementById('inProgressCount');
        const completedCountEl = document.getElementById('completedCount');
        const statusFilter = document.getElementById('statusFilter');
        const areaFilter = document.getElementById('areaFilter');
        const dateFilter = document.getElementById('dateFilter');
        const refreshBtn = document.getElementById('refreshBtn');
        const observationModal = document.getElementById('observationModal');
        const modalTitle = document.getElementById('modalTitle');
        const observationText = document.getElementById('observationText');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const modalCloseBtn = observationModal.querySelector('.modal-close');
        const modalCancelBtn = observationModal.querySelector('.modal-cancel');
        
        let allRequests = [];
        let currentRequestId = null;
        let currentAction = null;

        const toggleLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };

        const showNotification = (message, type = 'info') => {
            const notificationsContainer = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationsContainer.appendChild(notification);
            setTimeout(() => { if(notification.parentNode) notification.parentNode.removeChild(notification); }, 3000);
        };

        // [FUN√á√ÉO ADICIONADA] - Busca os dados da API do Google Apps Script
        const fetchData = async () => {
            toggleLoading(true);
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Erro de rede: ${response.status}`);
                const result = await response.json();

                // Ajuste para ler a resposta da nova API
                if (result.status === 'success') {
                    // Limpa e normaliza os dados recebidos da planilha
                    allRequests = result.data.map(r => ({...r, status: r.status ? String(r.status).toLowerCase().trim() : 'pendente' }));
                    populateAreaFilter();
                    render();
                    showNotification('Dados carregados com sucesso!', 'success');
                } else {
                    throw new Error(result.message || 'Erro ao buscar dados da API');
                }
            } catch (error) {
                showNotification(`Falha ao carregar dados: ${error.message}`, 'error');
                allRequests = [];
                render(); // Renderiza mesmo em caso de erro para mostrar o estado vazio
            } finally {
                toggleLoading(false);
            }
        };

        // [FUN√á√ÉO CORRIGIDA] - Envia atualiza√ß√µes para a API
        const updateData = async (id, novosDados) => {
            toggleLoading(true);
            try {
                // Monta o corpo da requisi√ß√£o no formato que nossa API espera
                const payload = {
                    id: id,
                    novosDados: novosDados
                };

                // Envia a requisi√ß√£o PUT para a nossa API
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Necess√°rio para o Apps Script
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Falha na requisi√ß√£o de atualiza√ß√£o.');

                const result = await response.json();

                if (result.status === 'success') {
                    showNotification('Atualiza√ß√£o enviada com sucesso!', 'success');
                    setTimeout(fetchData, 500); // Recarrega os dados ap√≥s a atualiza√ß√£o
                } else {
                    throw new Error(result.message || 'Erro ao atualizar na API');
                }

            } catch (error) {
                showNotification(`Falha ao atualizar: ${error.message}`, 'error');
                toggleLoading(false);
            }
        };
        
        // [N√ÉO H√Å MAIS UMA FUN√á√ÉO updateData DUPLICADA AQUI]

        const render = () => {
            const filteredRequests = getFilteredRequests();
            renderCounters(allRequests);
            renderRequestsList(filteredRequests);
        };

        const populateAreaFilter = () => {
            const currentArea = areaFilter.value;
            // Usa a chave correta da sua planilha
            const areas = [...new Set(allRequests.map(r => r['√Årea Solicitante']).filter(Boolean))];
            areaFilter.innerHTML = '<option value="todos">Todas as √Åreas</option>';
            areas.sort().forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
            if(areas.includes(currentArea)) areaFilter.value = currentArea;
        };

        const getFilteredRequests = () => {
            const status = statusFilter.value;
            const area = areaFilter.value;
            const date = dateFilter.value;

            return allRequests.filter(req => {
                const statusMatch = status === 'todos' || req.status === status;
                // Usa a chave correta da sua planilha
                const areaMatch = area === 'todos' || req['√Årea Solicitante'] === area;
                let dateMatch = true;
                if (date && req['Carimbo de data/hora']) {
                    try {
                        const reqDateStr = req['Carimbo de data/hora'].split(' ')[0];
                        const [day, month, year] = reqDateStr.split('/');
                        const requestDate = new Date(`${year}-${month}-${day}T00:00:00`);
                        const filterDate = new Date(`${date}T00:00:00`);
                        dateMatch = requestDate.getTime() === filterDate.getTime();
                    } catch(e) { dateMatch = false; }
                }
                return statusMatch && areaMatch && dateMatch;
            }).sort((a, b) => {
                try {
                    const dateA = new Date(a['Carimbo de data/hora'].split(' ')[0].split('/').reverse().join('-') + 'T' + a['Carimbo de data/hora'].split(' ')[1]);
                    const dateB = new Date(b['Carimbo de data/hora'].split(' ')[0].split('/').reverse().join('-') + 'T' + b['Carimbo de data/hora'].split(' ')[1]);
                    return dateB - dateA;
                } catch(e) { return 0; }
            });
        };

        const renderCounters = (requests) => {
            pendingCountEl.textContent = requests.filter(r => r.status === 'pendente').length;
            inProgressCountEl.textContent = requests.filter(r => r.status === 'em-andamento').length;
            completedCountEl.textContent = requests.filter(r => r.status === 'concluido').length;
        };

        const renderRequestsList = (requests) => {
            requestsList.innerHTML = '';
            if (requests.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            requests.forEach(req => {
                const card = document.createElement('div');
                card.className = `request-card status-${req.status}`;
                card.dataset.id = req.id;

                const priority = req['Tempo de Atendimento:'] || '';
                let priorityClass = '';
                if (priority.includes('Urgente')) priorityClass = 'urgente';
                else if (priority.includes('Moderado')) priorityClass = 'moderado';

                let detailsHtml = '';
                // Mapeia as chaves limpas (sem emojis) para os r√≥tulos que voc√™ quer mostrar
                const fields = {
                    'Solicitante': 'Solicitante', '√Årea Solicitante': '√Årea', 'Tipo de Opera√ß√£o:': 'Opera√ß√£o',
                    'C√≥digo do Item:': 'Item', 'Localiza√ß√£o (opcional)': 'Localiza√ß√£o', 'Observa√ß√£o (opcional)': 'Observa√ß√£o',
                    'operador': 'Operador', 'observacaoOperador': 'Obs. Operador', 'horarioInicio': 'In√≠cio', 'horarioConclusao': 'Conclus√£o'
                };
                
                for(const key in fields) {
                    if(req[key] && String(req[key]).trim() !== '') {
                        detailsHtml += `<div class="detail-item"><span class="detail-label">${fields[key]}</span><span class="detail-value">${req[key]}</span></div>`;
                    }
                }

                card.innerHTML = `
                    <div class="request-header">
                        <div>
                            <div class="request-id">ID: ${req.id || 'N/A'}</div>
                            <div class="request-timestamp">${req['Carimbo de data/hora'] || ''}</div>
                        </div>
                        ${priority ? `<div class="priority-tag ${priorityClass}">${priority}</div>` : ''}
                    </div>
                    <div class="request-details">${detailsHtml}</div>
                    <div class="card-actions"></div>`;
                
                const actionsContainer = card.querySelector('.card-actions');
                if (req.status === 'pendente') {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.textContent = '‚ñ∂Ô∏è Iniciar Atendimento';
                    btn.onclick = () => handleAction('start', req.id);
                    actionsContainer.appendChild(btn);
                } else if (req.status === 'em-andamento') {
                    const btnObs = document.createElement('button');
                    btnObs.className = 'btn btn-secondary';
                    btnObs.textContent = 'üìù Adicionar Observa√ß√£o';
                    btnObs.onclick = () => handleAction('observe', req.id);
                    actionsContainer.appendChild(btnObs);

                    const btnDone = document.createElement('button');
                    btnDone.className = 'btn btn-success';
                    btnDone.textContent = '‚úÖ Concluir Atendimento';
                    btnDone.onclick = () => handleAction('complete', req.id);
                    actionsContainer.appendChild(btnDone);
                } else {
                    actionsContainer.innerHTML = '<span>‚úÖ Conclu√≠do</span>';
                }
                requestsList.appendChild(card);
            });
        };

        const handleAction = (action, id) => {
            currentAction = action;
            currentRequestId = id;
            const request = allRequests.find(r => r.id === id);

            if (action === 'start') {
                updateData(id, { status: 'em-andamento', horarioInicio: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }) });
            } else if (action === 'complete') {
                updateData(id, { status: 'concluido', horarioConclusao: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }) });
            } else if (action === 'observe') {
                modalTitle.textContent = `Adicionar Observa√ß√£o para ID: ${request.id}`;
                observationText.value = request.observacaoOperador || '';
                observationModal.style.display = 'block';
            }
        };
        
        const closeModal = () => {
            observationModal.style.display = 'none';
            observationText.value = '';
            currentRequestId = null;
            currentAction = null;
        };

        confirmActionBtn.addEventListener('click', () => {
            if (currentAction === 'observe' && currentRequestId !== null) {
                updateData(currentRequestId, { observacaoOperador: observationText.value });
            }
            closeModal();
        });

        modalCloseBtn.addEventListener('click', closeModal);
        modalCancelBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == observationModal) closeModal();
        });
        
        [statusFilter, areaFilter, dateFilter].forEach(el => el.addEventListener('change', render));
        refreshBtn.addEventListener('click', fetchData);

        // Carrega os dados quando a p√°gina abre
        fetchData();
        // Atualiza a cada 60 segundos
        setInterval(fetchData, 60000);
    });
</script>
