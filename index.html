// ===================================================================== //
// ==               C√ìDIGO JAVASCRIPT PARA SHEETDB                    == //
// ===================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    // COLE AQUI A SUA NOVA URL DA API DO SHEETDB
    const SHEETDB_URL = 'https://sheetdb.io/api/v1/yio8jdqlh5pli';
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const requestsList = document.getElementById('requestsList');
    const emptyState = document.getElementById('emptyState');
    const pendingCountEl = document.getElementById('pendingCount');
    const inProgressCountEl = document.getElementById('inProgressCount');
    const completedCountEl = document.getElementById('completedCount');
    const statusFilter = document.getElementById('statusFilter');
    const areaFilter = document.getElementById('areaFilter');
    const dateFilter = document.getElementById('dateFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const observationModal = document.getElementById('observationModal');
    const modalTitle = document.getElementById('modalTitle');
    const observationText = document.getElementById('observationText');
    const confirmActionBtn = document.getElementById('confirmActionBtn');
    const modalCloseBtn = observationModal.querySelector('.modal-close');
    const modalCancelBtn = observationModal.querySelector('.modal-cancel');
    
    let allRequests = [];
    let currentRequestId = null;
    let currentAction = null;

    const toggleLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };

    const showNotification = (message, type = 'info') => {
        const notificationsContainer = document.getElementById('notifications');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationsContainer.appendChild(notification);
        setTimeout(() => { if(notification.parentNode) notification.parentNode.removeChild(notification); }, 3000);
    };

    const fetchData = async () => {
        toggleLoading(true);
        try {
            const response = await fetch(SHEETDB_URL);
            if (!response.ok) throw new Error(`Erro de rede: ${response.status}`);
            const data = await response.json();
            allRequests = data.map(r => ({...r, status: r.status ? String(r.status).toLowerCase().trim() : 'pendente' }));
            populateAreaFilter();
            render();
            showNotification('Dados carregados com sucesso!', 'success');
        } catch (error) {
            showNotification(`Falha ao carregar dados: ${error.message}`, 'error');
            allRequests = [];
            render();
        } finally { toggleLoading(false); }
    };

    const updateData = async (id, updatePayload) => {
        toggleLoading(true);
        try {
            const url = `${SHEETDB_URL}/id/${id}`;
            const response = await fetch(url, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatePayload)
            });
            if (!response.ok) throw new Error('Falha ao atualizar.');
            await response.json();
            showNotification('Atualiza√ß√£o enviada com sucesso!', 'success');
            setTimeout(fetchData, 500);
        } catch (error) {
            showNotification(`Falha ao atualizar: ${error.message}`, 'error');
            toggleLoading(false);
        }
    };

    const render = () => {
        const filteredRequests = getFilteredRequests();
        renderCounters(allRequests);
        renderRequestsList(filteredRequests);
    };

    const populateAreaFilter = () => {
        const currentArea = areaFilter.value;
        const areas = [...new Set(allRequests.map(r => r.areasolicitante).filter(Boolean))];
        areaFilter.innerHTML = '<option value="todos">Todas as √Åreas</option>';
        areas.sort().forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            areaFilter.appendChild(option);
        });
        if(areas.includes(currentArea)) areaFilter.value = currentArea;
    };

    const getFilteredRequests = () => {
        const status = statusFilter.value;
        const area = areaFilter.value;
        const date = dateFilter.value;

        return allRequests.filter(req => {
            const statusMatch = status === 'todos' || req.status === status;
            const areaMatch = area === 'todos' || req.areasolicitante === area;
            let dateMatch = true;
            if (date && req['carimbo_de_data/hora']) {
                try {
                    const reqDateStr = req['carimbo_de_data/hora'].split(' ')[0];
                    const [day, month, year] = reqDateStr.split('/');
                    const requestDate = new Date(`${year}-${month}-${day}T00:00:00`);
                    const filterDate = new Date(`${date}T00:00:00`);
                    dateMatch = requestDate.getTime() === filterDate.getTime();
                } catch(e) { dateMatch = false; }
            }
            return statusMatch && areaMatch && dateMatch;
        }).sort((a, b) => {
            try {
                const dateA = new Date(a['carimbo_de_data/hora'].split(' ')[0].split('/').reverse().join('-') + 'T' + a['carimbo_de_data/hora'].split(' ')[1]);
                const dateB = new Date(b['carimbo_de_data/hora'].split(' ')[0].split('/').reverse().join('-') + 'T' + b['carimbo_de_data/hora'].split(' ')[1]);
                return dateB - dateA;
            } catch(e) { return 0; }
        });
    };

    const renderCounters = (requests) => {
        pendingCountEl.textContent = requests.filter(r => r.status === 'pendente').length;
        inProgressCountEl.textContent = requests.filter(r => r.status === 'em-andamento').length;
        completedCountEl.textContent = requests.filter(r => r.status === 'concluido').length;
    };

    const renderRequestsList = (requests) => {
        requestsList.innerHTML = '';
        if (requests.length === 0) {
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';

        requests.forEach(req => {
            const card = document.createElement('div');
            card.className = `request-card status-${req.status}`;
            card.dataset.id = req.id;

            const priority = req.tempo_de_atendimento || '';
            let priorityClass = '';
            if (priority.includes('Urgente')) priorityClass = 'urgente';
            else if (priority.includes('Moderado')) priorityClass = 'moderado';

            let detailsHtml = '';
            const fields = {
                'solicitante': 'Solicitante', 'areasolicitante': '√Årea', 'tipo_de_opera√ß√£o': 'Opera√ß√£o',
                'c√≥digo_do_item': 'Item', 'localiza√ß√£o': 'Localiza√ß√£o', 'observa√ß√£o': 'Observa√ß√£o',
                'operador': 'Operador', 'observacao_operador': 'Obs. Operador', 'horario_inicio': 'In√≠cio', 'horario_conclusao': 'Conclus√£o'
            };
            
            for(const key in fields) {
                if(req[key] && String(req[key]).trim() !== '') {
                    detailsHtml += `<div class="detail-item"><span class="detail-label">${fields[key]}</span><span class="detail-value">${req[key]}</span></div>`;
                }
            }

            card.innerHTML = `
                <div class="request-header">
                    <div>
                        <div class="request-id">${req.id || 'N/A'}</div>
                        <div class="request-timestamp">${req['carimbo_de_data/hora'] || ''}</div>
                    </div>
                    ${priority ? `<div class="priority-tag ${priorityClass}">${priority}</div>` : ''}
                </div>
                <div class="request-details">${detailsHtml}</div>
                <div class="card-actions"></div>`;
            
            const actionsContainer = card.querySelector('.card-actions');
            if (req.status === 'pendente') {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.textContent = '‚ñ∂Ô∏è Iniciar Atendimento';
                btn.onclick = () => handleAction('start', req.id);
                actionsContainer.appendChild(btn);
            } else if (req.status === 'em-andamento') {
                const btnObs = document.createElement('button');
                btnObs.className = 'btn btn-secondary';
                btnObs.textContent = 'üìù Adicionar Observa√ß√£o';
                btnObs.onclick = () => handleAction('observe', req.id);
                actionsContainer.appendChild(btnObs);

                const btnDone = document.createElement('button');
                btnDone.className = 'btn btn-success';
                btnDone.textContent = '‚úÖ Concluir Atendimento';
                btnDone.onclick = () => handleAction('complete', req.id);
                actionsContainer.appendChild(btnDone);
            } else {
                actionsContainer.innerHTML = '<span>‚úÖ Conclu√≠do</span>';
            }
            requestsList.appendChild(card);
        });
    };

    const handleAction = (action, id) => {
        currentAction = action;
        currentRequestId = id;
        const request = allRequests.find(r => r.id === id);

        if (action === 'start') {
            updateData(id, { status: 'em-andamento', horario_inicio: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }) });
        } else if (action === 'complete') {
             updateData(id, { status: 'concluido', horario_conclusao: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }) });
        } else if (action === 'observe') {
            modalTitle.textContent = `Adicionar Observa√ß√£o para ${request.id}`;
            observationText.value = request.observacao_operador || '';
            observationModal.style.display = 'block';
        }
    };
    
    const closeModal = () => {
        observationModal.style.display = 'none';
        observationText.value = '';
        currentRequestId = null;
        currentAction = null;
    };

    confirmActionBtn.addEventListener('click', () => {
        if (currentAction === 'observe' && currentRequestId !== null) {
            updateData(currentRequestId, { observacao_operador: observationText.value });
        }
        closeModal();
    });

    modalCloseBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target == observationModal) closeModal();
    });
    
    [statusFilter, areaFilter, dateFilter].forEach(el => el.addEventListener('change', render));
    refreshBtn.addEventListener('click', fetchData);

    fetchData();
});
