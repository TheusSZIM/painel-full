<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetControl Pro | Sistema Online</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #334155;
            --text-light: #94a3b8;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }

        header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand { display: flex; align-items: center; gap: 1rem; }
        .logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
        .brand-text h1 { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .brand-text p { font-size: 0.75rem; color: var(--text-light); }

        .status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge.online { background: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .status-badge.connecting { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .nav-tabs { display: flex; gap: 0.5rem; background: var(--bg); padding: 0.25rem; border-radius: 8px; border: 1px solid var(--border); }
        .nav-tab { padding: 0.5rem 1rem; border: none; background: transparent; color: var(--text-light); font-weight: 600; font-size: 0.875rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .nav-tab.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .badge { background: var(--danger); color: white; font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 10px; margin-left: 0.25rem; }

        .section { display: none; padding: 2rem 0; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Alert Config */
        .config-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1);
        }

        .config-alert h3 { color: #92400e; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .config-alert p { color: #78350f; font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.6; }
        
        .input-group { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .input-group input { flex: 1; padding: 0.75rem; border: 2px solid #fbbf24; border-radius: 8px; font-size: 0.875rem; font-family: monospace; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        .btn-secondary { background: white; border: 2px solid var(--border); color: var(--text); }
        
        .debug-info { 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 1rem; 
            border-radius: 8px; 
            font-family: monospace; 
            font-size: 0.75rem; 
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Form */
        .form-container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .form-header { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
        .form-header h2 { color: var(--primary); margin-bottom: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; font-weight: 600; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.875rem; }
        .required::after { content: ' *'; color: var(--danger); }
        .form-control { width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); }
        
        .radio-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
        .radio-card { position: relative; }
        .radio-card input { position: absolute; opacity: 0; }
        .radio-content { padding: 0.875rem; border: 1.5px solid var(--border); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; transition: all 0.2s; background: white; }
        .radio-card:hover .radio-content { border-color: #cbd5e1; }
        .radio-card input:checked + .radio-content { border-color: var(--accent); background: #fffbeb; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
        .radio-icon { font-size: 1.25rem; }

        .btn-submit { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
        .btn-submit:disabled { opacity: 0.7; cursor: not-allowed; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card.red { border-top: 4px solid #ef4444; }
        .stat-card.blue { border-top: 4px solid #3b82f6; }
        .stat-card.yellow { border-top: 4px solid #f59e0b; }
        .stat-card.green { border-top: 4px solid #10b981; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); margin-top: 0.5rem; }
        .stat-label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }

        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .filter-tabs { display: flex; gap: 0.5rem; background: white; padding: 0.25rem; border-radius: 8px; border: 1px solid var(--border); }
        .tab-btn { padding: 0.5rem 1rem; border: none; background: transparent; color: var(--text-light); font-weight: 500; font-size: 0.875rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .requests-list { display: flex; flex-direction: column; gap: 0.75rem; }
        
        .request-card {
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .request-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
        }

        .request-card.urgente::before { background: #dc2626; }
        .request-card.normal::before { background: #3b82f6; }
        .request-card.andamento::before { background: #f59e0b; }
        .request-card.concluido::before { background: #10b981; }

        .card-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0; }
        .card-icon.urgente { background: #fee2e2; color: #dc2626; }
        .card-icon.normal { background: #dbeafe; color: #2563eb; }
        .card-icon.andamento { background: #fef3c7; color: #b45309; animation: spin 2s linear infinite; }
        .card-icon.concluido { background: #d1fae5; color: #059669; }

        .card-content { flex: 1; min-width: 0; }
        .card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.375rem; flex-wrap: wrap; }
        .card-title { font-weight: 700; color: var(--primary); font-size: 1rem; }
        
        .tag { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; }
        .tag-urgent { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .tag-moderate { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .tag-normal { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }

        .card-meta { display: flex; align-items: center; gap: 0.75rem; font-size: 0.8125rem; color: var(--text-light); flex-wrap: wrap; }
        .urgente-badge { color: #dc2626; font-weight: 700; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; }

        .card-actions { display: flex; gap: 0.5rem; }
        .btn-action { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 600; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .btn-start { background: var(--primary); color: white; }
        .btn-start:hover { background: #1e293b; }
        .btn-finish { background: var(--success); color: white; }
        .btn-finish:hover { background: #059669; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; background: #9ca3af; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 600; font-size: 0.8125rem; }

        .empty-state { text-align: center; padding: 4rem; color: var(--text-light); background: white; border-radius: 12px; border: 2px dashed var(--border); }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--primary); color: white; padding: 1rem 1.5rem; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-weight: 500; z-index: 1000; transform: translateX(150%); transition: transform 0.3s; display: flex; align-items: center; gap: 0.75rem; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="header-content">
            <div class="brand">
                <div class="logo">‚ö°</div>
                <div class="brand-text">
                    <h1>FleetControl Pro</h1>
                    <p id="subtitle">Sistema de Gest√£o</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="connStatus" class="status-badge offline">
                    <span>‚óè</span>
                    <span id="connText">OFFLINE</span>
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('form')">üìù Solicitar</button>
                    <button class="nav-tab" onclick="showTab('dashboard')">üìä Painel <span id="navBadge" class="badge hidden">0</span></button>
                </nav>
            </div>
        </div>
    </div>
</header>

<!-- CONFIGURA√á√ÉO (Mostrada quando n√£o conectado) -->
<div id="configSection" class="container" style="padding-top: 2rem;">
    <div class="config-alert">
        <h3>‚ö†Ô∏è Configura√ß√£o Necess√°ria</h3>
        <p>O sistema precisa se conectar √† sua planilha Google Sheets. Siga os passos abaixo:</p>
        
        <ol style="margin-left: 1.5rem; margin-bottom: 1rem; color: #78350f; font-size: 0.875rem; line-height: 1.8;">
            <li>Abra sua planilha: <a href="https://docs.google.com/spreadsheets/d/1vmuL-OXeanaYhVFD4sKJpHWfITxSyXFixyOleMBk4RE/edit" target="_blank" style="color: #d97706; font-weight: 600;">Clique aqui</a></li>
            <li>V√° em <strong>Extens√µes ‚Üí Apps Script</strong></li>
            <li>Delete o c√≥digo padr√£o e cole o c√≥digo abaixo:</li>
        </ol>

        <details style="margin-bottom: 1rem;">
            <summary style="cursor: pointer; color: #92400e; font-weight: 600; margin-bottom: 0.5rem;">üìã Ver C√≥digo do Apps Script</summary>
            <div style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.75rem; overflow-x: auto; line-height: 1.5;">
const SHEET_ID = '1vmuL-OXeanaYhVFD4sKJpHWfITxSyXFixyOleMBk4RE';
const SHEET_NAME = 'Form Responses 1';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    
    if (data.action === 'update' && data.id) {
      // Atualiza linha existente
      const values = sheet.getDataRange().getValues();
      for (let i = 1; i < values.length; i++) {
        if (values[i][8] === data.id) {
          if (data.status) sheet.getRange(i + 1, 10).setValue(data.status);
          if (data.horarioInicio) sheet.getRange(i + 1, 12).setValue(data.horarioInicio);
          if (data.horarioConclusao) sheet.getRange(i + 1, 13).setValue(data.horarioConclusao);
          if (data.operador) sheet.getRange(i + 1, 11).setValue(data.operador);
          break;
        }
      }
      return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Nova solicita√ß√£o
    const newId = Utilities.getUuid().substring(0, 8);
    sheet.appendRow([
      new Date(), data.solicitante, data.area, data.tipo, data.codigo,
      data.tempo, data.observacao || '-', data.localizacao || '-',
      newId, 'pendente', '', '', '', ''
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({success: true, id: newId})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getDisplayValues();
    const headers = ['timestamp','solicitante','area','tipo','codigo','tempo','observacao','localizacao','id','status','operador','horarioInicio','horarioConclusao','observacaoOperador'];
    const rows = [];
    for (let i = 1; i < data.length; i++) {
      const row = {};
      headers.forEach((h, j) => row[h] = data[i][j] || '');
      rows.push(row);
    }
    return ContentService.createTextOutput(JSON.stringify(rows)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({error: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}
            </div>
            <button onclick="copyCode()" style="margin-top: 0.5rem; background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">üìã Copiar C√≥digo</button>
        </details>

        <ol style="margin-left: 1.5rem; margin-bottom: 1rem; color: #78350f; font-size: 0.875rem; line-height: 1.8;" start="4">
            <li>Clique em <strong>Salvar</strong> (üíæ) e depois em <strong>Implantar ‚Üí Novo implanta√ß√£o</strong></li>
            <li>Tipo: <strong>Aplicativo da Web</strong> | Acesso: <strong>Qualquer pessoa</strong></li>
            <li>Copie a URL gerada e cole aqui:</li>
        </ol>

        <div class="input-group">
            <input type="text" id="apiUrlInput" placeholder="https://script.google.com/macros/s/.../exec" style="flex: 1;">
            <button onclick="connectAPI()" class="btn btn-primary">Conectar</button>
        </div>
        
        <div id="debugOutput" class="debug-info hidden"></div>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #fbbf24;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #92400e; font-size: 0.875rem;">
                <input type="checkbox" id="useMock" onchange="toggleMock()"> Usar dados de demonstra√ß√£o (modo offline)
            </label>
        </div>
    </div>
</div>

<!-- CONTE√öDO PRINCIPAL (Escondido at√© conectar) -->
<div id="mainContent" class="hidden">
    <section id="formSection" class="section active">
        <div class="container">
            <div class="form-container">
                <div class="form-header">
                    <h2>Nova Solicita√ß√£o</h2>
                    <p style="color: var(--text-light); font-size: 0.875rem;">Preencha os dados abaixo. Ser√° salvo na planilha automaticamente.</p>
                </div>
                
                <form id="requestForm" onsubmit="handleSubmit(event)">
                    <div class="form-group">
                        <label class="form-label required">Solicitante</label>
                        <input type="text" class="form-control" id="solicitante" required placeholder="Nome completo">
                    </div>

                    <div class="form-group">
                        <label class="form-label required">√Årea Solicitante</label>
                        <div class="radio-group">
                            <label class="radio-card"><input type="radio" name="area" value="Inje√ß√£o de Alum√≠nio" required><div class="radio-content"><span class="radio-icon">üè≠</span><span>Inje√ß√£o de Alum√≠nio</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Inje√ß√£o PPS" required><div class="radio-content"><span class="radio-icon">üß™</span><span>Inje√ß√£o PPS</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Log√≠stica" required><div class="radio-content"><span class="radio-icon">üöö</span><span>Log√≠stica</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Montagem Manual" required><div class="radio-content"><span class="radio-icon">üîß</span><span>Montagem Manual</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Montagem Automatizada" required><div class="radio-content"><span class="radio-icon">ü§ñ</span><span>Montagem Automatizada</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Manuten√ß√£o INJ" required><div class="radio-content"><span class="radio-icon">üî®</span><span>Manuten√ß√£o INJ</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Torno" required><div class="radio-content"><span class="radio-icon">‚öôÔ∏è</span><span>Torno</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Usinagem" required><div class="radio-content"><span class="radio-icon">üî©</span><span>Usinagem</span></div></label>
                            <label class="radio-card"><input type="radio" name="area" value="Qualidade" required><div class="radio-content"><span class="radio-icon">‚≠ê</span><span>Qualidade</span></div></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Tipo de Opera√ß√£o</label>
                        <div class="radio-group" style="grid-template-columns: repeat(3, 1fr);">
                            <label class="radio-card"><input type="radio" name="tipo" value="Entrega" required><div class="radio-content"><span class="radio-icon">üì¶</span><span>Entrega</span></div></label>
                            <label class="radio-card"><input type="radio" name="tipo" value="Guarda" required><div class="radio-content"><span class="radio-icon">üîí</span><span>Guarda</span></div></label>
                            <label class="radio-card"><input type="radio" name="tipo" value="Valida√ß√£o" required><div class="radio-content"><span class="radio-icon">‚úîÔ∏è</span><span>Valida√ß√£o</span></div></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">C√≥digo do Item</label>
                        <input type="text" class="form-control" id="codigo" required placeholder="Ex: 83420-000">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Localiza√ß√£o</label>
                        <input type="text" class="form-control" id="localizacao" placeholder="Ex: Doca 3 ‚Üí Estoque A/12">
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Tempo de Atendimento</label>
                        <div class="radio-group">
                            <label class="radio-card"><input type="radio" name="tempo" value="00:15 (Urgente)" required><div class="radio-content" style="border-left: 4px solid #dc2626;"><span class="radio-icon">üö®</span><div><div style="font-weight: 600;">00:15 Urgente</div><div style="font-size: 0.75rem; color: #dc2626;">Parada cr√≠tica</div></div></div></label>
                            <label class="radio-card"><input type="radio" name="tempo" value="00:30 (Moderado)" required><div class="radio-content" style="border-left: 4px solid #f59e0b;"><span class="radio-icon">‚ö†Ô∏è</span><div><div style="font-weight: 600;">00:30 Moderado</div><div style="font-size: 0.75rem; color: #b45309;">Prioridade alta</div></div></div></label>
                            <label class="radio-card"><input type="radio" name="tempo" value="01:00 (Normal)" required><div class="radio-content" style="border-left: 4px solid #10b981;"><span class="radio-icon">‚úÖ</span><div><div style="font-weight: 600;">01:00 Normal</div><div style="font-size: 0.75rem; color: #059669;">Fluxo padr√£o</div></div></div></label>
                            <label class="radio-card"><input type="radio" name="tempo" value="02:00 (Padr√£o)" required><div class="radio-content" style="border-left: 4px solid #3b82f6;"><span class="radio-icon">üïê</span><div><div style="font-weight: 600;">02:00 Padr√£o</div><div style="font-size: 0.75rem; color: #2563eb;">Sem urg√™ncia</div></div></div></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Observa√ß√£o</label>
                        <textarea class="form-control" id="observacao" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
                    </div>

                    <button type="submit" class="btn-submit" id="submitBtn">
                        <span>Enviar Solicita√ß√£o</span>
                        <span>‚Üí</span>
                    </button>
                </form>
            </div>
        </div>
    </section>

    <section id="dashboardSection" class="section">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card red">
                    <div class="stat-label">Urgentes</div>
                    <div class="stat-value" id="statUrgent">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Pendentes</div>
                    <div class="stat-value" id="statPending">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">Em Andamento</div>
                    <div class="stat-value" id="statProgress">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Conclu√≠das</div>
                    <div class="stat-value" id="statDone">0</div>
                </div>
            </div>

            <div class="controls">
                <div class="filter-tabs">
                    <button class="tab-btn active" onclick="filterStatus('all')">Todas</button>
                    <button class="tab-btn" onclick="filterStatus('pendente')">Pendentes</button>
                    <button class="tab-btn" onclick="filterStatus('andamento')">Andamento</button>
                    <button class="tab-btn" onclick="filterStatus('concluido')">Conclu√≠das</button>
                </div>
                <button onclick="loadData()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>üîÑ</span> Atualizar
                </button>
            </div>

            <div id="requestsList" class="requests-list">
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                    <p>Carregando...</p>
                </div>
            </div>
        </div>
    </section>
</div>

<div id="toast" class="toast">
    <span id="toastIcon">‚úì</span>
    <span id="toastMsg">Mensagem</span>
</div>

<script>
    // CONFIGURA√á√ÉO - ALTERE AQUI
    let API_URL = localStorage.getItem('fleetcontrol_api_url') || '';
    let USE_MOCK = false;
    let requests = [];
    let isOnline = false;
    let currentFilter = 'all';

    // Dados mockados para teste
    const MOCK_DATA = [
        {
            timestamp: '02/02/2026 08:30:00',
            solicitante: 'Matheus',
            area: 'Inje√ß√£o de Alum√≠nio',
            tipo: 'Entrega',
            codigo: '83420-000',
            tempo: '00:15 (Urgente)',
            observacao: '-',
            localizacao: '-',
            id: 'abc-123',
            status: 'pendente',
            operador: '',
            horarioInicio: '',
            horarioConclusao: ''
        },
        {
            timestamp: '02/02/2026 09:15:00',
            solicitante: 'Ana Paula',
            area: 'Log√≠stica',
            tipo: 'Guarda',
            codigo: '10.001.1724',
            tempo: '01:00 (Normal)',
            observacao: 'Material fr√°gil',
            localizacao: 'Doca 3 ‚Üí Estoque A',
            id: 'def-456',
            status: 'andamento',
            operador: 'Operador Web',
            horarioInicio: '02/02/2026 09:20:00',
            horarioConclusao: ''
        }
    ];

    window.onload = function() {
        // Se tiver URL salva, tenta conectar automaticamente
        if (API_URL && !API_URL.includes('XXXXXXXX')) {
            connectAPI();
        } else {
            showConfig();
        }
    };

    function showConfig() {
        document.getElementById('configSection').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('connStatus').className = 'status-badge offline';
        document.getElementById('connText').textContent = 'OFFLINE';
    }

    function showMain() {
        document.getElementById('configSection').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
    }

    function toggleMock() {
        USE_MOCK = document.getElementById('useMock').checked;
        if (USE_MOCK) {
            requests = [...MOCK_DATA];
            isOnline = false;
            showMain();
            renderRequests();
            updateStats();
            showToast('Modo demonstra√ß√£o ativado', 'success');
            document.getElementById('connStatus').className = 'status-badge offline';
            document.getElementById('connText').textContent = 'DEMO';
            document.getElementById('subtitle').textContent = 'Modo de Demonstra√ß√£o';
        }
    }

    async function connectAPI() {
        const urlInput = document.getElementById('apiUrlInput');
        const url = urlInput.value.trim();
        
        if (!url || !url.includes('script.google.com')) {
            showToast('URL inv√°lida! Deve ser uma URL do script.google.com', 'error');
            return;
        }

        API_URL = url;
        localStorage.setItem('fleetcontrol_api_url', url);
        
        document.getElementById('connStatus').className = 'status-badge connecting';
        document.getElementById('connText').textContent = 'CONECTANDO...';
        
        const debugDiv = document.getElementById('debugOutput');
        debugDiv.classList.remove('hidden');
        debugDiv.innerHTML = '<div>üîÑ Testando conex√£o...</div>';
        
        try {
            const response = await fetch(API_URL + '?t=' + Date.now());
            const text = await response.text();
            
            debugDiv.innerHTML += '<div>‚úÖ Resposta recebida (' + text.length + ' chars)</div>';
            
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                debugDiv.innerHTML += '<div style="color: #f87171;">‚ùå Erro: Resposta n√£o √© JSON v√°lido</div>';
                debugDiv.innerHTML += '<div style="color: #94a3b8; margin-top: 0.5rem;">Preview: ' + text.substring(0, 200) + '...</div>';
                throw new Error('Resposta n√£o √© JSON');
            }
            
            if (Array.isArray(data)) {
                requests = data;
                isOnline = true;
                USE_MOCK = false;
                
                showMain();
                renderRequests();
                updateStats();
                
                document.getElementById('connStatus').className = 'status-badge online';
                document.getElementById('connText').textContent = 'ONLINE';
                document.getElementById('subtitle').textContent = 'Sincronizado com Google Sheets';
                
                showToast('‚úÖ Conectado com sucesso! ' + data.length + ' registros carregados.', 'success');
                debugDiv.innerHTML += '<div style="color: #34d399;">‚úÖ ' + data.length + ' registros carregados</div>';
                
                // Atualiza a cada 30s
                setInterval(() => {
                    if (document.getElementById('dashboardSection').classList.contains('active')) {
                        loadData();
                    }
                }, 30000);
                
            } else if (data.error) {
                throw new Error('Erro do servidor: ' + data.error);
            } else {
                throw new Error('Formato inesperado: n√£o √© um array');
            }
            
        } catch (error) {
            debugDiv.innerHTML += '<div style="color: #f87171;">‚ùå ' + error.message + '</div>';
            document.getElementById('connStatus').className = 'status-badge offline';
            document.getElementById('connText').textContent = 'ERRO';
            showToast('‚ùå ' + error.message, 'error');
        }
    }

    async function loadData() {
        if (USE_MOCK || !isOnline) return;
        
        try {
            const response = await fetch(API_URL + '?t=' + Date.now());
            const data = await response.json();
            
            if (Array.isArray(data)) {
                requests = data;
                renderRequests();
                updateStats();
            }
        } catch (error) {
            console.error('Erro ao atualizar:', error);
        }
    }

    async function handleSubmit(e) {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Enviando...';

        const formData = {
            solicitante: document.getElementById('solicitante').value,
            area: document.querySelector('input[name="area"]:checked').value,
            tipo: document.querySelector('input[name="tipo"]:checked').value,
            codigo: document.getElementById('codigo').value,
            tempo: document.querySelector('input[name="tempo"]:checked').value,
            observacao: document.getElementById('observacao').value,
            localizacao: document.getElementById('localizacao').value
        };

        try {
            if (USE_MOCK) {
                // Modo offline - adiciona local
                await new Promise(r => setTimeout(r, 1000));
                const newId = 'mock-' + Date.now();
                requests.unshift({
                    ...formData,
                    id: newId,
                    timestamp: new Date().toLocaleString('pt-BR'),
                    status: 'pendente',
                    operador: '',
                    horarioInicio: '',
                    horarioConclusao: ''
                });
                showToast('üíæ Salvo localmente (modo offline)', 'success');
            } else {
                // Modo online - envia para API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('‚úÖ Enviado para a planilha!', 'success');
                    await loadData(); // Recarrega a lista
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            }
            
            document.getElementById('requestForm').reset();
            setTimeout(() => showTab('dashboard'), 500);
            
        } catch (error) {
            showToast('‚ùå Erro: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>Enviar Solicita√ß√£o</span><span>‚Üí</span>';
        }
    }

    async function updateStatus(id, newStatus) {
        const now = new Date().toLocaleString('pt-BR');
        const updateData = {
            action: 'update',
            id: id,
            status: newStatus,
            operador: 'Operador Web'
        };

        if (newStatus === 'andamento') {
            updateData.horarioInicio = now;
        } else if (newStatus === 'concluido') {
            updateData.horarioConclusao = now;
        }

        try {
            if (USE_MOCK) {
                // Atualiza local
                const idx = requests.findIndex(r => r.id === id);
                if (idx !== -1) {
                    requests[idx].status = newStatus;
                    if (newStatus === 'andamento') requests[idx].horarioInicio = now;
                    if (newStatus === 'concluido') requests[idx].horarioConclusao = now;
                }
            } else {
                // Atualiza na API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(updateData),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                
                await loadData();
            }
            
            renderRequests();
            updateStats();
            showToast(newStatus === 'andamento' ? '‚ñ∂ Opera√ß√£o iniciada' : '‚úÖ Opera√ß√£o conclu√≠da', 'success');
            
        } catch (error) {
            showToast('‚ùå Erro ao atualizar: ' + error.message, 'error');
        }
    }

    function renderRequests() {
        const container = document.getElementById('requestsList');
        
        let filtered = requests;
        if (currentFilter !== 'all') {
            filtered = requests.filter(r => r.status === currentFilter);
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div><p>Nenhuma solicita√ß√£o encontrada</p></div>';
            updateBadge(0);
            return;
        }

        container.innerHTML = filtered.map(req => {
            const isUrgent = req.tempo && req.tempo.includes('Urgente');
            const isAndamento = req.status === 'andamento';
            const isConcluido = req.status === 'concluido';
            
            let cardClass = 'normal';
            let iconClass = 'normal';
            let icon = 'üì¶';
            
            if (isUrgent && !isAndamento && !isConcluido) {
                cardClass = 'urgente';
                iconClass = 'urgente';
                icon = 'üö®';
            } else if (isAndamento) {
                cardClass = 'andamento';
                iconClass = 'andamento';
                icon = '‚öôÔ∏è';
            } else if (isConcluido) {
                cardClass = 'concluido';
                iconClass = 'concluido';
                icon = '‚úì';
            }

            const timeClass = isUrgent ? 'tag-urgent' : 
                             req.tempo && req.tempo.includes('Moderado') ? 'tag-moderate' : 'tag-normal';

            let actionBtn = '';
            if (req.status === 'pendente') {
                actionBtn = `<button onclick="updateStatus('${req.id}', 'andamento')" class="btn-action btn-start">‚ñ∂ Iniciar</button>`;
            } else if (req.status === 'andamento') {
                actionBtn = `<button onclick="updateStatus('${req.id}', 'concluido')" class="btn-action btn-finish">‚úì Finalizar</button>`;
            } else {
                actionBtn = `<button disabled>Conclu√≠do</button>`;
            }

            return `
                <div class="request-card ${cardClass}">
                    <div class="card-icon ${iconClass}">${icon}</div>
                    <div class="card-content">
                        <div class="card-header">
                            <span class="card-title">${req.tipo}: ${req.codigo}</span>
                            <span class="tag ${timeClass}">${req.tempo ? req.tempo.split(' ')[0] : '--:--'}</span>
                        </div>
                        <div class="card-meta">
                            ${isUrgent && !isConcluido ? '<span class="urgente-badge">üö® URGENTE</span>' : ''}
                            <span>üë§ ${req.solicitante}</span>
                            <span>‚Ä¢</span>
                            <span>üè≠ ${req.area}</span>
                            ${req.localizacao && req.localizacao !== '-' ? `<span>‚Ä¢</span><span>üìç ${req.localizacao}</span>` : ''}
                            <span>‚Ä¢</span>
                            <span>üïê ${req.timestamp}</span>
                        </div>
                    </div>
                    <div class="card-actions">${actionBtn}</div>
                </div>
            `;
        }).join('');

        const urgentCount = requests.filter(r => r.status === 'pendente' && r.tempo && r.tempo.includes('Urgente')).length;
        updateBadge(urgentCount);
    }

    function updateStats() {
        const urgentes = requests.filter(r => r.tempo && r.tempo.includes('Urgente') && r.status !== 'concluido').length;
        const pendentes = requests.filter(r => r.status === 'pendente').length;
        const andamento = requests.filter(r => r.status === 'andamento').length;
        const concluidas = requests.filter(r => r.status === 'concluido').length;
        
        document.getElementById('statUrgent').textContent = urgentes;
        document.getElementById('statPending').textContent = pendentes;
        document.getElementById('statProgress').textContent = andamento;
        document.getElementById('statDone').textContent = concluidas;
    }

    function updateBadge(count) {
        const badge = document.getElementById('navBadge');
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function showTab(tab) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        
        if (tab === 'form') {
            document.getElementById('formSection').classList.add('active');
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
        } else {
            document.getElementById('dashboardSection').classList.add('active');
            document.querySelectorAll('.nav-tab')[1].classList.add('active');
            if (isOnline) loadData();
        }
    }

    function filterStatus(status) {
        currentFilter = status;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderRequests();
    }

    function copyCode() {
        const code = document.querySelector('details .debug-info') || document.querySelector('details div');
        if (code) {
            navigator.clipboard.writeText(code.innerText);
            showToast('üìã C√≥digo copiado!', 'success');
        }
    }

    function showToast(msg, type) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMsg').textContent = msg;
        document.getElementById('toastIcon').textContent = type === 'success' ? '‚úì' : '‚úó';
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>

</body>
</html>
